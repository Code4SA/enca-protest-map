function initialize(){function l(){var e=200,i=$("#map").width(),s=d3.time.scale().domain([t,n]).range([e,0]),o=d3.time.scale().domain([n,t]).range([0,i]);r.x(o).on("brush",g);back_month=new Date(t);back_month=back_month.setMonth(back_month.getMonth()-3);g();b();var u=f.append("g").classed("brush-overlay",!0).attr("class","brush").call(r);u.selectAll("rect").attr("height",70)}function c(){var e=s._zoom,t=s.getBounds(),n=s.getCenter();window.location.hash="#zoom="+e+"&ne_lat="+t._northEast.lat+"&ne_lng="+t._northEast.lng+"&sw_lat="+t._southWest.lat+"&sw_lng="+t._southWest.lng+"&type_id="+$("#protest_types option:selected").val()+"&brush_start="+r.extent()[0]+"&brush_end="+r.extent()[1]+"&center_lat="+n.lat+"&center_lng="+n.lng;$("#embed_code").val("<iframe src='"+window.location+"&embed=1' width='600' height='800'></iframe>")}function h(e){e.attr("cx",function(e){return s.latLngToLayerPoint(e.LatLng).x});e.attr("cy",function(e){return s.latLngToLayerPoint(e.LatLng).y})}function p(e){brush_show=e.date<r.extent()[1]&&e.date>r.extent()[0];type_id=$("#protest_types option:selected").val();type_id==0?filter_show=!0:e.type_id==type_id?filter_show=!0:filter_show=!1;return brush_show&&filter_show}function d(){y={};var e=0,r=[];type_id=$("#protest_types option:selected").val();a.selectAll(".protest-dot").each(function(t){type_id==0?fitler_show=!0:t.type_id==type_id?filter_show=!0:filter_show=!1;if(filter_show){y[t.date]?y[t.date]=y[t.date]+1:y[t.date]=1;e<y[t.date]&&(e=y[t.date])}});for(dix in y)r.push({date:dix,val:y[dix]});var i=d3.time.scale().domain([n,t]).range([20,f.attr("width")-20]),s=d3.scale.linear().domain([0,e]).range([f.attr("height"),18]);f.selectAll(".bar").remove();var o=f.selectAll(".bar").data(r).enter().append("g").attr("class","bar").attr("transform",function(e){return"translate("+i(new Date(e.date))+","+s(e.val)+")"});o.append("rect").attr("x",1).attr("width",2).attr("transform","translate(0, -0)").attr("height",90)}function v(){a.selectAll(".protest-dot").classed("hidden",function(e){return!p(e)}).classed("shown",function(e){return p(e)});a.selectAll(".shown").attr("r",4*s._zoom).transition().duration(500).ease("bounce").attr("r",s._zoom);c()}function m(){v();d()}function g(){var t=new Array("January","February","March","April","May","June","July","August","September","October","November","December");d3.select("#visible_date").text(e(r.extent()[0])+" - "+e(r.extent()[1]));v()}function b(){var e={top:0,right:30,bottom:0,left:30};height=f.attr("height");width=f.attr("width");a.selectAll(".protest-dot").each(function(e){var r=new Date(e.Start_Date);r>t&&(t=r);r<n&&(n=r);e.LatLng=new L.LatLng(e.Latitude,e.Longitude);e.date=r});var s=new Date(t);i.brush_start=i.brush_start||s.setMonth(s.getMonth()-1);i.brush_end=i.brush_end||t;r.extent([new Date(i.brush_start),new Date(i.brush_end)]);g();var o=d3.time.scale().domain([n,t]).range([20,width-20]),u=d3.svg.axis().scale(o).orient("bottom").ticks(9).outerTickSize(0);f.append("g").attr("class","x axis").attr("transform","translate(0,0)").call(u);d()}function w(t){var n=d3.select("#hover");n.classed("loading",!0);n.classed("hidden",!1);var r=t.ISSID;$.getJSON("https://code4sa.demo.socrata.com/resource/7y3u-atvk.json?ISSID="+r,function(t){n.classed("loading",!1);t=t.pop();t.start_date==t.end_date?n.select("#date").text(e(new Date(t.start_date))):n.select("#date").text(e(new Date(t.start_date))+" to "+e(new Date(t.end_date)));n.select("#Violent_or_violent").text(t.violent_or_violent);n.select("#type").text(t.type);n.select("#TownCity_Name").text(t.towncity_name);n.select("#Suburbareaplacename").text(t.suburbareaplacename);n.select("#Reasonforprotest").text(t.reasonforprotest);n.select("#Municipality_metro").text(t.municipality_metro);n.select("#First_Street").text(t.first_street)})}var e=d3.time.format("%e %B, %Y"),t=0,n=new Date,r=d3.svg.brush(),i={};i.ne_lat=-16;i.ne_lng=42;i.sw_lat=-38;i.sw_lng=7;i.zoom=5;i.center_lat=-29;i.center_lng=24;i.brush_start=!1;i.brush_end=!1;i.embed=!1;$.each(window.location.hash.replace("#","").split("&"),function(e,t){var n=t.split("=");i[n[0]]=n[1]});i.embed&&$("body").addClass("embedded");var s=L.map("map",{minZoom:5,zoom:i.zoom}).setView([i.center_lat,i.center_lng],i.zoom);L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{}).addTo(s);s.setMaxBounds([[-16,42],[-38,7]]);s._initPathRoot();s.on("zoomend",function(e){a.selectAll(".shown").attr("r",s._zoom)});s.on("moveend",function(e){c()});var o=d3.select("#map").select("svg"),u=$("#map").width();$(window).on("resize",function(){u=$("#map").width();d3.select("#scrubber").attr("width",u);b()});var a=o.append("g"),f=d3.select("#scrubber").append("svg").attr("width",u).attr("height",70),t=new Date(0),n=new Date,y={};s.on("mousemove",function(e){posY=e.originalEvent.y;e.target._size.y/e.containerPoint.y>2?d3.select("#hover").style("top",posY+10+"px"):d3.select("#hover").style("top",posY-d3.select("#hover")[0][0].clientHeight-10+"px");var t=500,n=$("#container").offset().left,r=800+n,i=0+n;e.originalEvent.clientX>r-t/2?d3.select("#hover").style("left",r-t/2-Math.round(t/2)+"px"):e.originalEvent.clientX<i+t/2?d3.select("#hover").style("left",i+"px"):d3.select("#hover").style("left",e.originalEvent.clientX-Math.round(t/2)+"px")});d3.csv("protestdata_small.csv").get(function(e,r){var o={},u=["All types"];for(var f=0;f<r.length;f++){var c=r[f],p=new Date(c.Start_Date);p>t&&(t=p);p<n&&(n=p);r[f].LatLng=new L.LatLng(r[f].Latitude,r[f].Longitude);r[f].date=p;u[c.type_id]=c.type}d3.select("#protest_types").append("select").on("change",m).classed("form-control",!0).selectAll("option").data(u).enter().append("option").attr("value",function(e,t){return t}).attr("selected",function(e,t){if(t==i.type_id)return"selected"}).text(function(e){return e});var d=a.selectAll("circle").data(r).enter().append("circle").attr("r",function(e){return 20}).attr("class","protest-dot hidden").classed("violent",function(e){return e["violent"]=="1"}).attr("data-protest-type",function(e){return e.type_id}).on("mouseover",function(e){w(e)}).on("mouseout",function(e){d3.select("#hover").classed("hidden",!0)}).on("click",function(e){d3.select("#hover").classed("hidden",!1)});h(d);s.on("viewreset",function(){h(d)});l()})}var zoom_multiplier=1;