function initialize(){function c(){var e=t._zoom,n=t.getBounds(),r=t.getCenter();window.location.hash="#zoom="+e+"&ne_lat="+n._northEast.lat+"&ne_lng="+n._northEast.lng+"&sw_lat="+n._southWest.lat+"&sw_lng="+n._southWest.lng+"&type_id="+$("#protest_types option:selected").val()+"&brush_start="+f.extent()[0]+"&brush_end="+f.extent()[1]+"&center_lat="+r.lat+"&center_lng="+r.lng}function h(e){e.attr("cx",function(e){return t.latLngToLayerPoint(e.LatLng).x});e.attr("cy",function(e){return t.latLngToLayerPoint(e.LatLng).y})}function p(e){d3.select("#complete").style("width",e+"%")}function d(e){brush_show=e.date<f.extent()[1]&&e.date>f.extent()[0];type_id=$("#protest_types option:selected").val();type_id==0?filter_show=!0:e.type_id==type_id?filter_show=!0:filter_show=!1;return brush_show&&filter_show}function v(){E={};var e=0,t=[];type_id=$("#protest_types option:selected").val();u.selectAll(".protest-dot").each(function(t){type_id==0?fitler_show=!0:t.type_id==type_id?filter_show=!0:filter_show=!1;if(filter_show){E[t.date]?E[t.date]=E[t.date]+1:E[t.date]=1;e<E[t.date]&&(e=E[t.date])}});for(dix in E)t.push({date:dix,val:E[dix]});var n=d3.time.scale().domain([w,b]).range([20,o.attr("width")-20]),r=d3.scale.linear().domain([0,e]).range([o.attr("height"),18]);o.selectAll(".bar").remove();var i=o.selectAll(".bar").data(t).enter().append("g").attr("class","bar").attr("transform",function(e){return"translate("+n(new Date(e.date))+","+r(e.val)+")"});i.append("rect").attr("x",1).attr("width",2).attr("transform","translate(0, -0)").attr("height",90)}function m(){u.selectAll(".protest-dot").classed("hidden",function(e){return!d(e)}).classed("shown",function(e){return d(e)});u.selectAll(".shown").attr("r",4*t._zoom).transition().duration(500).ease("bounce").attr("r",t._zoom);c()}function g(){m();v()}function y(){var e=new Array("January","February","March","April","May","June","July","August","September","October","November","December");d3.select("#visible_date").text(l(f.extent()[0])+" - "+l(f.extent()[1]));m()}function S(t,n){var r={top:0,right:30,bottom:0,left:30};height=n.attr("height");width=n.attr("width");for(var i=0;i<t.length;i++){var s=t[i],o=new Date(s.Start_Date);o>b&&(b=o);o<w&&(w=o);t[i].LatLng=new L.LatLng(t[i].Latitude,t[i].Longitude);t[i].date=o}var u=new Date(b);e.brush_start=e.brush_start||u.setMonth(u.getMonth()-1);e.brush_end=e.brush_end||b;f.extent([new Date(e.brush_start),new Date(e.brush_end)]);y();var i=d3.time.scale().domain([w,b]).range([20,width-20]),a=d3.svg.axis().scale(i).orient("bottom").ticks(9).outerTickSize(0);n.append("g").attr("class","x axis").attr("transform","translate(0,0)").call(a);v()}var e={};e.ne_lat=-16;e.ne_lng=42;e.sw_lat=-38;e.sw_lng=7;e.zoom=5;e.center_lat=-29;e.center_lng=24;e.brush_start=!1;e.brush_end=!1;$.each(window.location.hash.replace("#","").split("&"),function(t,n){var r=n.split("=");e[r[0]]=r[1]});console.log(e);var t=L.map("map",{minZoom:5,zoom:e.zoom}).setView([e.center_lat,e.center_lng],e.zoom);L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{}).addTo(t);t.setMaxBounds([[-16,42],[-38,7]]);t.on("zoomend",function(e){u.selectAll(".shown").attr("r",t._zoom)});t.on("moveend",function(e){c()});var n=0,r=[],i=null;t._initPathRoot();var s=d3.select("#map").select("svg"),o=d3.select("#scrubber").append("svg").attr("width",800).attr("height",70),u=s.append("g"),a=200,f=d3.svg.brush(),l=d3.time.format("%e %B, %Y"),b=0,w=new Date,E={};t.on("mousemove",function(e){posY=e.originalEvent.y;e.target._size.y/e.containerPoint.y>2?d3.select("#hover").style("top",posY+10+"px"):d3.select("#hover").style("top",posY-d3.select("#hover")[0][0].clientHeight-10+"px");d3.select("#hover").style("left",e.originalEvent.clientX-200+"px")});d3.csv("protestdata_1.csv").get(function(n,r){var s=0,c=new Date,p={},d=[];d[0]="All types";for(var v=0;v<r.length;v++){var m=r[v],b=new Date(m.Start_Date);b>s&&(s=b);b<c&&(c=b);r[v].LatLng=new L.LatLng(r[v].Latitude,r[v].Longitude);r[v].date=b;p[r[v].date]?p[r[v].date]=p[r[v].date]+1:p[r[v].date]=1;d[m.type_id]=m.type}d3.select("#protest_types").append("select").classed("form-control",!0).selectAll("option").data(d).enter().append("option").attr("value",function(e,t){return t}).attr("selected",function(t,n){if(n==e.type_id)return"selected"}).text(function(e){return e});d3.select("#protest_types").on("change",g);var w=u.selectAll("circle").data(r).enter().append("circle").attr("r",function(e){return 20}).attr("class","protest-dot hidden").classed("violent",function(e){return e["violent"]=="1"}).attr("data-protest-type",function(e){return e.type_id}).on("mouseover",function(e){var t=d3.select("#hover").classed("hidden",!1);e.Start_Date==e.End_Date?t.select("#date").text(l(new Date(e.Start_Date))):t.select("#date").text(l(new Date(e.Start_Date))+" to "+l(new Date(e.End_Date)));t.select("#Violent_or_violent").text(e.Violent_or_violent);t.select("#type").text(e.type);t.select("#TownCity_Name").text(e.TownCity_Name);t.select("#Suburbareaplacename").text(e.Suburbareaplacename);t.select("#Reasonforprotest").text(e.Reasonforprotest);t.select("#Municipality_metro").text(e.Municipality_metro);t.select("#First_Street").text(e.First_Street)}).on("mouseout",function(e){d3.select("#hover").classed("hidden",!0)});h(w);t.on("viewreset",function(){w.attr("cx",function(e){return t.latLngToLayerPoint(e.LatLng).x});w.attr("cy",function(e){return t.latLngToLayerPoint(e.LatLng).y})});i=d3.time.scale().domain([s,c]).range([a,0]);scrubber_scale=d3.time.scale().domain([c,s]).range([0,800]);y2=d3.scale.linear().range([100,0]);var E=d3.svg.area().interpolate("monotone").x(scrubber_scale).y0(100).y1(function(e){return y2(e.date)});f.x(scrubber_scale).on("brush",y);back_month=new Date(s);back_month=back_month.setMonth(back_month.getMonth()-1);y();S(r,o);var x=o.append("g").classed("brush-overlay",!0).attr("class","brush").call(f);x.selectAll("rect").attr("height",70)})}var zoom_multiplier=1;