function dateRangeObj(e,t){var n=this;n.date_start=!1;n.date_end=!1;n.subscribed=[];n.update=function(e,t,r){t&&(n.date_start=new Date(t));r&&(n.date_end=new Date(r));if(n.date_end<n.date_start){var i=n.date_end;n.date_end=n.date_start;n.date_start=i}n.update_subscribers(e);$(n).trigger("updated")};n.subscribe=function(e,t,r,i){e.on(t,i);n.subscribed.push({subscriber:e,eventName:t,updateFunc:r,onFunc:i})};n.update_subscribers=function(e){$.each(n.subscribed,function(t,n){e!=n.subscriber&&n.updateFunc()})};n.val=function(){return[n.date_start,n.date_end]}}function initialize(){function w(){var e=200,i=$("#map").width(),s=d3.time.scale().domain([t,n]).range([e,0]),o=d3.time.scale().domain([n,t]).range([0,i]);r.x(o);k();O();var u=b.append("g").classed("brush-overlay",!0).attr("class","brush").call(r);u.selectAll("rect").attr("height",70)}function E(){var e=v._zoom,t=v.getBounds(),n=v.getCenter();window.location.hash="#zoom="+e+"&ne_lat="+t._northEast.lat+"&ne_lng="+t._northEast.lng+"&sw_lat="+t._southWest.lat+"&sw_lng="+t._southWest.lng+"&type_id="+$("#protest_types option:selected").val()+"&brush_start="+r.extent()[0]+"&brush_end="+r.extent()[1]+"&center_lat="+n.lat+"&center_lng="+n.lng;$("#embed_code").val("<iframe src='"+window.location+"&embed=1' width='600' height='800'></iframe>")}function S(e){e.attr("cx",function(e){return v.latLngToLayerPoint(e.LatLng).x});e.attr("cy",function(e){return v.latLngToLayerPoint(e.LatLng).y})}function x(e){brush_show=e.date<new Date(dateRange.val()[1])&&e.date>new Date(dateRange.val()[0]);type_id=$("#protest_types option:selected").val();type_id==0?filter_show=!0:e.type_id==type_id?filter_show=!0:filter_show=!1;return brush_show&&filter_show}function T(){A={};var e=0,r=[];type_id=$("#protest_types option:selected").val();y.selectAll(".protest-dot").each(function(t){type_id==0?fitler_show=!0:t.type_id==type_id?filter_show=!0:filter_show=!1;if(filter_show){A[t.date]?A[t.date]=A[t.date]+1:A[t.date]=1;e<A[t.date]&&(e=A[t.date])}});for(dix in A)r.push({date:dix,val:A[dix]});var i=d3.time.scale().domain([n,t]).range([20,b.attr("width")-20]),s=d3.scale.linear().domain([0,e]).range([b.attr("height"),18]);b.selectAll(".bar").remove();var o=b.selectAll(".bar").data(r).enter().append("g").attr("class","bar").attr("transform",function(e){return"translate("+i(new Date(e.date))+","+s(e.val)+")"});o.append("rect").attr("x",1).attr("width",2).attr("transform","translate(0, -0)").attr("height",90)}function N(){y.selectAll(".protest-dot").classed("hidden",function(e){return!x(e)}).classed("shown",function(e){return x(e)});y.selectAll(".shown").attr("r",4*v._zoom).transition().duration(100).ease("bounce").attr("r",v._zoom);E()}function C(){N();T()}function k(){var e=new Array("January","February","March","April","May","June","July","August","September","October","November","December");N()}function O(){var e={top:0,right:30,bottom:0,left:30};height=b.attr("height");width=b.attr("width");y.selectAll(".protest-dot").each(function(e){var r=new Date(e.Start_Date);r>t&&(t=r);r<n&&(n=r);e.LatLng=new L.LatLng(e.Latitude,e.Longitude);e.date=r});var i=new Date(t);u.brush_start=u.brush_start||i.setMonth(i.getMonth()-1);u.brush_end=u.brush_end||t;r.extent([dateRange.val()[0],dateRange.val()[1]]);k();var s=d3.time.scale().domain([n,t]).range([20,width-20]),o=d3.svg.axis().scale(s).orient("bottom").ticks(9).outerTickSize(0);b.append("g").attr("class","x axis").attr("transform","translate(0,0)").call(o);T()}function M(e){posY=e.originalEvent.y;e.target._size.y/e.containerPoint.y>2?d3.select("#hover").style("top",posY+10+"px"):d3.select("#hover").style("top",posY-d3.select("#hover")[0][0].clientHeight-10+"px");var t=500,n=$("#container").offset().left,r=800+n,i=0+n;e.originalEvent.clientX>r-t/2?d3.select("#hover").style("left",r-t/2-Math.round(t/2)+"px"):e.originalEvent.clientX<i+t/2?d3.select("#hover").style("left",i+"px"):d3.select("#hover").style("left",e.originalEvent.clientX-Math.round(t/2)+"px")}function _(t){var n=d3.select("#hover");n.classed("loading",!0);n.classed("hidden",!1);var r=t.ISSID;$.getJSON("https://code4sa.demo.socrata.com/resource/7y3u-atvk.json?ISSID="+r,function(t){n.classed("loading",!1);t=t.pop();t.start_date==t.end_date?n.select("#date").text(e(new Date(t.start_date))):n.select("#date").text(e(new Date(t.start_date))+" to "+e(new Date(t.end_date)));n.select("#Violent_or_violent").text(t.violent_or_violent);n.select("#type").text(t.type);n.select("#TownCity_Name").text(t.towncity_name);n.select("#Suburbareaplacename").text(t.suburbareaplacename);n.select("#Reasonforprotest").text(t.reasonforprotest);n.select("#Municipality_metro").text(t.municipality_metro);n.select("#First_Street").text(t.first_street)})}var e=d3.time.format("%e %B, %Y"),t=0,n=new Date,r=d3.svg.brush(),i=d3.time.format("%B %Y"),s=[],o=!1,u={};u.ne_lat=-16;u.ne_lng=42;u.sw_lat=-38;u.sw_lng=7;u.zoom=5;u.center_lat=-29;u.center_lng=24;u.brush_start=!1;u.brush_end=!1;u.embed=!1;$.each(window.location.hash.replace("#","").split("&"),function(e,t){var n=t.split("=");u[n[0]]=n[1]});u.embed&&$("body").addClass("embedded");var a=L.tileLayer("http://{s}.tile.stamen.com/toner-lite/{z}/{x}/{y}.png",{attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',subdomains:"abcd"}),f=L.tileLayer("http://{s}.tile.stamen.com/terrain/{z}/{x}/{y}.png",{attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',subdomains:"abcd"}),l=L.tileLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles &copy; Esri &mdash; Source: Esri",minZoom:9,maxZoom:13}),c=L.tileLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand), TomTom, 2012",minZoom:9,maxZoom:13}),h=L.tileLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles &copy; Esri &mdash; Source: US National Park Service",maxZoom:8}),p=L.tileLayer("http://{s}.tile.stamen.com/toner-lines/{z}/{x}/{y}.png",{attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',subdomains:"abcd",minZoom:0,maxZoom:8}),d=L.tileLayer("http://{s}.tile.stamen.com/toner-labels/{z}/{x}/{y}.png",{attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',subdomains:"abcd",minZoom:0,maxZoom:8}),v=L.map("map",{minZoom:5,zoom:u.zoom}).setView([u.center_lat,u.center_lng],u.zoom);c.addTo(v);h.addTo(v);p.addTo(v);d.addTo(v);v.setMaxBounds([[-15.5,46],[-39,10.5]]);v._initPathRoot();v.on("zoomend",function(e){y.selectAll(".shown").attr("r",v._zoom)});v.on("moveend",function(e){E()});var m=d3.select("#map").select("svg"),g=$("#map").width();$(window).on("resize",function(){g=$("#map").width();d3.select("#scrubber").attr("width",g);O()});var y=m.append("g"),b=d3.select("#scrubber").append("svg").attr("width",g).attr("height",70),t=new Date(0),n=new Date,A={};v.on("mousemove",function(e){if(o)return!1;M(e)});d3.csv("protestdata_small.csv").get(function(a,f){var l={},c=["All types"];for(var h=0;h<f.length;h++){var p=f[h],d=new Date(p.Start_Date);d>t&&(t=d);d<n&&(n=d);f[h].LatLng=new L.LatLng(f[h].Latitude,f[h].Longitude);f[h].date=d;c[p.type_id]=p.type}d3.select("#protest_types").append("select").on("change",C).classed("form-control",!0).selectAll("option").data(c).enter().append("option").attr("value",function(e,t){return t}).attr("selected",function(e,t){if(t==u.type_id)return"selected"}).text(function(e){return e});s=d3.time.scale().domain([n,t]).ticks(d3.time.month);d3.select("#start_date").selectAll("option").data(s).enter().append("option").attr("value",function(e,t){return e}).text(function(e){return i(e)});d3.select("#end_date").selectAll("option").data(s).enter().append("option").attr("value",function(e,t){return e}).text(function(e){return i(e)});var m=y.selectAll("circle").data(f).enter().append("circle").attr("r",function(e){return 20}).attr("class","protest-dot hidden").classed("violent",function(e){return e["violent"]=="1"}).attr("data-protest-type",function(e){return e.type_id}).on("mouseover",function(e){o||_(e)}).on("mouseout",function(e){o||d3.select("#hover").classed("hidden",!0)});S(m);v.on("viewreset",function(){S(m)});dateRange=new dateRangeObj;$(dateRange).on("updated",function(){N()});w();dateRange.subscribe($("#start_date"),"change",function(){var e=new Date(dateRange.val()[0]),t=new Date(e.getFullYear(),e.getMonth(),1);$("#start_date option[value='"+t+"']").attr("selected","selected")},function(){var e=$("#start_date").val();dateRange.update($("#start_date"),new Date(e))});dateRange.subscribe($("#end_date"),"change",function(){var e=new Date(dateRange.val()[1]),t=new Date(e.getFullYear(),e.getMonth(),1);$("#end_date option[value='"+t+"']").attr("selected","selected")},function(){var e=$(this).val();dateRange.update($(this),!1,new Date(e))});dateRange.subscribe($("#visible_date"),"",function(){d3.select("#visible_date").text(e(new Date(dateRange.val()[0]))+" - "+e(new Date(dateRange.val()[1])))});dateRange.subscribe(r,"brush",function(){r.extent([new Date(dateRange.val()[0]),new Date(dateRange.val()[1])]);r(b)},function(){dateRange.update("brush",new Date(r.extent()[0]),new Date(r.extent()[1]))});var g=new Date(t);u.brush_start=u.brush_start||g.setMonth(g.getMonth()-1);u.brush_end=u.brush_end||t;dateRange.update(this,new Date(u.brush_start),new Date(u.brush_end))})}var zoom_multiplier=1;