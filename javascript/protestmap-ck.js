function initialize(){function l(t){t.attr("cx",function(t){return e.latLngToLayerPoint(t.LatLng).x});t.attr("cy",function(t){return e.latLngToLayerPoint(t.LatLng).y})}function c(e){d3.select("#complete").style("width",e+"%")}function h(){var t=new Array("January","February","March","April","May","June","July","August","September","October","November","December");d3.select("#visible_date").text(f(a.extent()[0])+" - "+f(a.extent()[1]));o.selectAll(".protest-dot").classed("hidden",function(e){return e.date<a.extent()[1]&&e.date>a.extent()[0]?!1:!0}).classed("shown",function(e){return e.date<a.extent()[1]&&e.date>a.extent()[0]?!0:!1});o.selectAll(".shown").attr("r",4*e._zoom).transition().duration(500).ease("bounce").attr("r",e._zoom)}function p(e,t){var n={top:10,right:30,bottom:30,left:30};width=t.attr("width");height=t.attr("height");var r=0,i=new Date,s={},o=0;for(var u=0;u<e.length;u++){var a=e[u],f=new Date(a.Start_Date);f>r&&(r=f);f<i&&(i=f);e[u].LatLng=new L.LatLng(e[u].Latitude,e[u].Longitude);e[u].date=f;s[e[u].date]?s[e[u].date]=s[e[u].date]+1:s[e[u].date]=1;o<s[e[u].date]&&(o=s[e[u].date])}var l=[];for(dix in s)l.push({date:dix,val:s[dix]});var u=d3.time.scale().domain([i,r]).range([0,width]),c=d3.scale.linear().domain([0,o]).range([height,n.bottom]),h=d3.svg.axis().scale(u).orient("bottom").ticks(8),p=t.selectAll(".bar").data(l).enter().append("g").attr("class","bar").attr("transform",function(e){return"translate("+u(new Date(e.date))+","+c(e.val)+")"});p.append("rect").attr("x",1).attr("width",2).attr("transform","translate(0, -"+n.bottom+")").attr("height",function(e){return height-c(e.val)});t.append("g").attr("class","x axis").attr("transform","translate(0,"+(height-n.bottom)+")").call(h)}var e=L.map("map",{minZoom:5,zoom:6}).setView([-29,24],5);L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(e);e.setMaxBounds([[-16,42],[-38,7]]);e.on("zoomend",function(t){o.selectAll(".shown").attr("r",e._zoom)});var t=0,n=[],r=null;e._initPathRoot();var i=d3.select("#map").select("svg"),s=d3.select("#scrubber").append("svg").attr("width",800).attr("height",100),o=i.append("g"),u=200,a=d3.svg.brush(),f=d3.time.format("%e %B, %Y");e.on("mousemove",function(e){posY=e.originalEvent.y;e.target._size.y/e.containerPoint.y>2?d3.select("#hover").style("top",posY+10+"px"):d3.select("#hover").style("top",posY-d3.select("#hover")[0][0].clientHeight-10+"px");d3.select("#hover").style("left",e.originalEvent.clientX-200+"px")});d3.csv("protestdata.csv").get(function(t,n){var i=0,c=new Date,d={};for(var v=0;v<n.length;v++){var m=n[v],y=new Date(m.Start_Date);y>i&&(i=y);y<c&&(c=y);n[v].LatLng=new L.LatLng(n[v].Latitude,n[v].Longitude);n[v].date=y;d[n[v].date]?d[n[v].date]=d[n[v].date]+1:d[n[v].date]=1}var b=o.selectAll("circle").data(n).enter().append("circle").attr("r",function(e){return 20}).attr("class","protest-dot hidden").classed("violent",function(e){return e["Violent_or_non_violent CODE"]=="1.00"}).on("mouseover",function(e){var t=d3.select("#hover").classed("hidden",!1);e.Start_Date==e.End_Date?t.select("#date").text(f(new Date(e.Start_Date))):t.select("#date").text(f(new Date(e.Start_Date))+" to "+f(new Date(e.End_Date)));t.select("#Violent_or_violent").text(e.Violent_or_violent);t.select("#TownCity_Name").text(e.TownCity_Name);t.select("#Suburbareaplacename").text(e.Suburbareaplacename);t.select("#Reasonforprotest").text(e.Reasonforprotest);t.select("#Municipality_metro").text(e.Municipality_metro);t.select("#First_Street").text(e.First_Street)}).on("mouseout",function(e){d3.select("#hover").classed("hidden",!0)}).on("click",function(e){d3.json("http://wards.code4sa.org/?database=wards_2011&address="+e.Latitude+","+e.Longitude,function(e){var t="http://embed.wazimap.co.za/static/iframe.html?chartType=histogram&chartHeight=200&chartQualifier=&chartTitle=Voters+by+party&initialSort=&statType=scaled-percentage",n={voting:{chartDataID:"elections-national_2014-party_distribution",chartTitle:"Voters by party"},water:{chartDataID:"service_delivery-water_source_distribution",chartTitle:"Population by water source"},refuse:{chartDataID:"service_delivery-refuse_disposal_distribution",chartTitle:"Population by refuse disposal"}};for(cid in n){var r=t+"&geoID=ward-"+e[0].ward+"&chartDataID="+n[cid].chartDataID+"&chartTitle="+n[cid].chartTitle;d3.select("#wazi-embed-"+cid).attr("src",r)}})});l(b);e.on("viewreset",function(){b.attr("cx",function(t){return e.latLngToLayerPoint(t.LatLng).x});b.attr("cy",function(t){return e.latLngToLayerPoint(t.LatLng).y})});r=d3.time.scale().domain([i,c]).range([u,0]);scrubber_scale=d3.time.scale().domain([c,i]).range([0,800]);y2=d3.scale.linear().range([100,0]);var w=d3.svg.area().interpolate("monotone").x(scrubber_scale).y0(100).y1(function(e){return y2(e.date)});a.x(scrubber_scale).on("brush",h);back_month=new Date(i);back_month=back_month.setMonth(back_month.getMonth()-1);a.extent([new Date(back_month),new Date(i)]);h();p(n,s);var E=s.append("g").classed("brush-overlay",!0).attr("class","brush").call(a);E.selectAll("rect").attr("height",70)})}var zoom_multiplier=1;